---
import BlogPost from "../../../layouts/BlogPost.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const all = await getCollection("blog");
  return all.map((entry) => {
    const noExt = entry.id.replace(/\.(md|mdx)$/i, "");
    const [lang, ...rest] = noExt.split("/");
    return {
      params: { lang, slug: rest.join("/") },
      props: { entry },
    };
  });
}

const { lang } = Astro.params;
const { entry } = Astro.props;
const { Content } = await render(entry);

const otherLang = lang === "pt" ? "en" : "pt";
const siblings = await getCollection(
  "blog",
  ({ data }) => data.postId === entry.data.postId
);
const other = siblings.find((e) => e.data.lang === otherLang);
const otherSlug = other
  ? other.id
      .replace(/\.(md|mdx)$/i, "")
      .split("/")
      .slice(1)
      .join("/")
  : null;
---

<BlogPost
  lang={lang as "pt" | "en"}
  title={entry.data.title}
  description={entry.data.description}
  pubDate={entry.data.pubDate}
  updatedDate={entry.data.updatedDate}
  heroImage={entry.data.heroImage}
>
  <Content />

  {
    otherSlug && (
      <p style="margin-top:2rem">
        <a href={`/${otherLang}/blog/${otherSlug}`}>
          {otherLang === "pt" ? "Ler em PortuguÃªs" : "Read in English"}
        </a>
      </p>
    )
  }
</BlogPost>
